<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ì˜¤í”ˆë§í¬ í˜‘ë ¥ì‚¬ í˜„í™©</title>
  <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=y42tkwc67w&submodules=geocoder"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 20px; }
    #map { width: 100%; height: 600px; border-radius: 8px; margin-top: 10px; }
    #info-box { display: flex; flex-direction: row; justify-content: space-between; padding: 10px; background: #f4f6f8; margin-top: 10px; }
    #info, #nearby-list { flex: 1; padding: 10px; }
    #clicked-address, #clicked-location { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
    #clicked-address { color: #0077cc; }
    #clicked-location { color: #92400e; background: #fff5cc; padding: 5px; border-left: 5px solid #facc15; }
    .radius-buttons { margin: 10px 0; }
    .radius-buttons button {
      margin-right: 10px; padding: 5px 10px; border-radius: 5px;
      background-color: #e0e7ff; border: none; cursor: pointer;
    }
    .radius-buttons button:hover { background-color: #c7d2fe; }
    input[type="text"] {
      padding: 6px; border-radius: 4px; border: 1px solid #ccc; width: 200px;
    }
    button {
      padding: 6px 10px; border-radius: 4px; border: none;
      background-color: #38bdf8; color: white; cursor: pointer;
    }
    button:hover { background-color: #0ea5e9; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
      font-size: clamp(12px, 1.1vw, 16px); table-layout: fixed;
    }
    th, td {
      padding: 10px; text-align: center; border-bottom: 1px solid #ddd;
      overflow-wrap: break-word; word-break: keep-all;
    }
    th { background-color: #eef2ff; cursor: pointer; }
    th:hover { background-color: #dbeafe; }
    tr:hover { background-color: #f9f9f9; }
    .point-icon { width: 20px; height: 20px; vertical-align: middle; margin-right: 5px; }

    /* ì¸í¬ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .info-card {
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      padding: 15px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      margin-top: 10px;
      max-width: 600px;
      font-size: 15px;
      color: #1e293b;
    }
    .info-card .title {
      font-size: 18px;
      font-weight: bold;
      color: #2563eb;
      margin-bottom: 8px;
    }
    .info-card .sub-info { color: #475569; margin-bottom: 5px; }
    .info-section { margin-top: 10px; padding-top: 8px; border-top: 1px dashed #cbd5e1; }
    .info-section strong { color: #0f172a; }
    .info-tags { display: flex; gap: 10px; margin-top: 5px; flex-wrap: wrap; }
    .info-tag { background-color: #f1f5f9; padding: 4px 8px; border-radius: 5px; font-weight: bold; color: #334155; }

    /* âœ… (ì¶”ê°€) ì»¬ëŸ¼ ëŠ˜ì–´ë‚œ í…Œì´ë¸” ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
    #nearby-list { overflow-x: auto; }
    #factory-table { min-width: 980px; }
  </style>
</head>
<body>
  <img src="https://taksong-driver.openmile.kr/openlink.png" style="width: 139px; height: 22px;" />
  <h2>ğŸ¢ ì˜¤í”ˆë§í¬ í˜‘ë ¥ì‚¬ í˜„í™©</h2>

  <div style="display:flex; justify-content: space-between; align-items:center;">
    <div>
      <input type="text" id="addressInput" placeholder="ğŸ” ì£¼ì†Œ ì…ë ¥">
      <button onclick="searchAddress()">ê²€ìƒ‰</button>
      <span>ë˜ëŠ” ğŸ—ºï¸ ì§€ë„ í´ë¦­ìœ¼ë¡œ ì„ íƒ</span>
    </div>
    <div style="margin-left: 350px;">
      <label for="uploadExcel">ğŸ“ ì—‘ì…€ ì—…ë¡œë“œ:</label>
      <input type="file" id="uploadExcel" accept=".xlsx" onchange="loadFactoriesExcel(event)">
    </div>
  </div>

  <div class="radius-buttons">
    <label>ğŸ“ ë°˜ê²½:</label>
    <button onclick="setRadius(5)">5km</button>
    <button onclick="setRadius(10)">10km</button>
    <button onclick="setRadius(20)">20km</button>
    <button onclick="setRadius(30)">30km</button>
    <button onclick="setRadius(40)">40km</button>
  </div>

  <div id="map"></div>

  <div id="info-box">
    <div id="info">
      <div id="clicked-address">ğŸ“ í‘œì‹œì§€ì ì˜ ì£¼ì†Œê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div id="clicked-location">ğŸ“ ì„ íƒëœ ìœ„ì¹˜: ì—†ìŒ</div>
      <div id="factory-info">â„¹ï¸ í˜‘ë ¥ì‚¬ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <div id="nearby-list">
      <strong>ğŸ“ ë°˜ê²½ ë‚´ í˜‘ë ¥ì‚¬</strong>
      <table id="factory-table">
        <thead>
          <tr>
            <th>ê³µì—…ì‚¬ëª…</th>
            <th>ê±°ë¦¬(km)</th>

            <!-- âœ… (ì¶”ê°€) ì…ê³ ëŒ€ìˆ˜ 3ê°œ ì»¬ëŸ¼ -->
            <th>ì›”ìˆ˜ë¦¬</th>
            <th>í˜„ì¬ì…ê³ </th>
            <th>ì…ê³ ê°€ëŠ¥</th>

            <th>ì¼ë°˜ìˆ˜ë¦¬</th>
            <th>ì‚¬ê³ ìˆ˜ë¦¬</th>
            <th><img class="point-icon" src="https://i.namu.wiki/i/r6Nfd2W4VJfQJd0rMjfHzjzOjZD2HbWGsxHdaTh4aPqN8S1Dsp74jVYCwdXUcu9ry-6jzm5_JDWl7OmjIEaSMuPAnJr0WATQq0JLGrvgewEiKPC99V9c3MJThzQyXLQEDA2AOBqbn0cn-9tAhR5cnw.svg" alt="í˜„ëŒ€"></th>
            <th><img class="point-icon" src="https://i.namu.wiki/i/LPxAPP6P7emfhzu6bzsn19bP1ZZXn2jshG9OPQ3z8P8oSnRbqsTV-mXvJYTzubY831Dh_-MPLWrNxg2_a5aQfe1nzq_Fst_fghKDKHA6TtheVMkKLhwsUdsF8VdcTBJgB4Qz9juN_kOPZ5PCnci1Lw.svg" alt="ê¸°ì•„"></th>
          </tr>
        </thead>
        <tbody id="factory-list"></tbody>
      </table>
    </div>
  </div>

  <script>
    let factories = [], map, circle = null, selectedMarker = null;
    let radius = 10, markers = [], currentNearby = [];

    function getStatusTag(flag) {
      if (flag === 'â—‹') return '<span style="color:#2563eb;font-weight:bold">ê°€ëŠ¥</span>';
      if (flag === 'â…©' || flag === 'X') return '<span style="color:#dc2626;font-weight:bold">ë¶ˆê°€ëŠ¥</span>';
      return '<span style="color:#6b7280;">-</span>';
    }

    function showFactoryInfo(factory) {
      document.getElementById('factory-info').innerHTML = `
        <div class="info-card">
          <div class="title">ğŸš— ${factory.name}</div>
          <div class="sub-info">ğŸ“ ${factory.address}</div>
          <div class="sub-info">ğŸ·ï¸ ë“±ê¸‰: <strong>${factory.grade}</strong> &nbsp;&nbsp; â˜ï¸ ì—°ë½ì²˜: <strong>${factory.phone || '-'}</strong></div>

          <div class="info-section">
            <strong>ğŸ› ï¸ ìˆ˜ë¦¬ ê°€ëŠ¥ì—¬ë¶€</strong>
            <div class="info-tags">
              <span class="info-tag">ì¼ë°˜ìˆ˜ë¦¬: ${getStatusTag(factory.repairGeneral)}</span>
              <span class="info-tag">ì‚¬ê³ ìˆ˜ë¦¬: ${getStatusTag(factory.repairAccident)}</span>
            </div>
          </div>

          <div class="info-section">
            <strong>ğŸ“¦ ì…ê³  ì •ë³´</strong>
            <div class="info-tags">
              <span class="info-tag">ğŸ”§ ì›”ìˆ˜ë¦¬: ${factory.monthlyCapacity ?? '-'}</span>
              <span class="info-tag">ğŸ“¥ í˜„ì¬ì…ê³ : ${factory.currentIncoming ?? '-'}</span>
              <span class="info-tag">ğŸšš ì…ê³ ê°€ëŠ¥: ${factory.possibleIncoming ?? '-'}</span>
            </div>
          </div>

          <div class="info-section">
            <strong>ğŸ­ ì œì¡°ì‚¬ í¬ì¸íŠ¸</strong>
            <div class="info-tags">
              <span class="info-tag">í˜„ëŒ€: ${getStatusTag(factory.pointHyundai)}</span>
              <span class="info-tag">ê¸°ì•„: ${getStatusTag(factory.pointKia)}</span>
            </div>
          </div>

          ${factory.notes && factory.notes !== '0' ? `
            <div class="info-section">
              <strong>ğŸ“ ì°¸ê³ ì‚¬í•­</strong>
              <div style="margin-top: 5px;">${factory.notes}</div>
            </div>` : ''}
        </div>
      `;
    }

    function loadFactoriesExcel(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        factories = json.map(row => ({
          name: row['í˜‘ë ¥ì‚¬ëª…'],
          address: row['ì£¼ì†Œ'],
          phone: row['ì—°ë½ì²˜'],
          grade: row['ê¸‰ìˆ˜'],
          lat: row['ìœ„ë„'],
          lng: row['ê²½ë„'],
          monthlyCapacity: row['ì›” ìˆ˜ë¦¬ê°€ëŠ¥ëŒ€ìˆ˜'],
          currentIncoming: row['í˜„ì¬ ì…ê³ (ì˜ˆì •)ëŒ€ìˆ˜'],
          possibleIncoming: row['ì…ê³ ê°€ëŠ¥ëŒ€ìˆ˜'],
          repairGeneral: row['ì¼ë°˜'],
          repairAccident: row['ì‚¬ê³ '],
          pointHyundai: row['í¬ì¸íŠ¸(í˜„ëŒ€)'],
          pointKia: row['í¬ì¸íŠ¸(ê¸°ì•„)'],
          notes: row['ì¶”ê°€ì„¤ëª…']
        }));

        markers.forEach(m => m.marker.setMap(null));
        markers = [];

        factories.forEach(factory => {
          const pos = new naver.maps.LatLng(factory.lat, factory.lng);
          const marker = new naver.maps.Marker({ position: pos, map });
          marker.addListener('click', () => showFactoryInfo(factory));
          markers.push({ marker, factory });
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function updateAddressLabel(latlng) {
      naver.maps.Service.reverseGeocode({ coords: latlng }, function(status, response) {
        if (status === naver.maps.Service.Status.OK) {
          const addr = response.v2.address.roadAddress || response.v2.address.jibunAddress;
          document.getElementById("clicked-location").innerText = `ğŸ“ ì„ íƒëœ ìœ„ì¹˜: ${addr}`;
        }
      });
    }

    function updateMarkerStyles(center) {
      const tbody = document.getElementById('factory-list');
      tbody.innerHTML = '';
      const lat = center.lat(), lng = center.lng();

      currentNearby = markers.map(({ marker, factory }) => {
        const dist = haversine(lat, lng, factory.lat, factory.lng) / 1000;
        const inRange = dist <= radius;

        marker.setIcon(inRange
          ? { url: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png' }
          : { url: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png' });

        return inRange ? { ...factory, dist } : null;
      }).filter(Boolean);

      currentNearby.sort((a, b) => a.dist - b.dist);

      for (const f of currentNearby) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.name}</td>
          <td>${f.dist.toFixed(2)}</td>

          <!-- âœ… (ì¶”ê°€) ì…ê³ ëŒ€ìˆ˜ 3ê°œ td -->
          <td>${f.monthlyCapacity ?? '-'}</td>
          <td>${f.currentIncoming ?? '-'}</td>
          <td>${f.possibleIncoming ?? '-'}</td>

          <td>${getStatusTag(f.repairGeneral)}</td>
          <td>${getStatusTag(f.repairAccident)}</td>
          <td>${getStatusTag(f.pointHyundai)}</td>
          <td>${getStatusTag(f.pointKia)}</td>
        `;
        tr.addEventListener('click', () => showFactoryInfo(f));
        tbody.appendChild(tr);
      }
    }

    function drawCircle(center) {
      if (circle) circle.setMap(null);
      circle = new naver.maps.Circle({
        map, center,
        radius: radius * 1000,
        strokeColor: '#007aff',
        strokeWeight: 2,
        fillColor: '#cce5ff',
        fillOpacity: 0.4
      });
    }

    function setRadius(r) {
      radius = r;
      if (selectedMarker) {
        drawCircle(selectedMarker.getPosition());
        updateMarkerStyles(selectedMarker.getPosition());
      }
    }

    function searchAddress() {
      const query = document.getElementById('addressInput').value;
      if (!query) return;
      naver.maps.Service.geocode({ query }, function(status, response) {
        if (status !== naver.maps.Service.Status.OK) {
          alert('ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨'); return;
        }
        const item = response.v2.addresses[0];
        const latlng = new naver.maps.LatLng(item.y, item.x);
        if (selectedMarker) selectedMarker.setMap(null);
        selectedMarker = new naver.maps.Marker({
          position: latlng, map,
          icon: {
            content: '<div style="width:10px;height:10px;border-radius:50%;background:#000;border:2px solid white;"></div>',
            size: new naver.maps.Size(12, 12), anchor: new naver.maps.Point(6, 6)
          }
        });
        map.setCenter(latlng);
        updateAddressLabel(latlng);
        drawCircle(latlng);
        updateMarkerStyles(latlng);
      });
    }

    function haversine(lat1, lng1, lat2, lng2) {
      const R = 6371e3, toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function initMap() {
      map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(36.5, 127.5),
        zoom: 8
      });
      naver.maps.Event.addListener(map, 'click', function(e) {
        const latlng = e.coord;
        if (selectedMarker) selectedMarker.setMap(null);
        selectedMarker = new naver.maps.Marker({
          position: latlng, map,
          icon: {
            content: '<div style="width:10px;height:10px;border-radius:50%;background:#000;border:2px solid white;"></div>',
            size: new naver.maps.Size(12, 12), anchor: new naver.maps.Point(6, 6)
          }
        });
        updateAddressLabel(latlng);
        drawCircle(latlng);
        updateMarkerStyles(latlng);
      });
    }

    window.onload = initMap;
  </script>
</body>
</html>
